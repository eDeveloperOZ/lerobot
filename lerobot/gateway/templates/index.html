<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LeRobot Gateway</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    input, textarea { width: 100%; margin-bottom: 1em; }
    button { padding: 0.5em 1em; }
    pre { background: #f0f0f0; padding: 1em; }
  </style>
</head>
<body>
  <h1>LeRobot Gateway</h1>
  <h2>Robot Connection</h2>
  <div id="connectSection">
    <label>WebSocket URL: <input id="wsUrl" value="ws://localhost:8765"></label><br>
    <label>Baud Rate: <input id="baudRate" value="115200"></label><br>
    <button id="connectBtn">Connect Robot</button>
    <button id="disconnectBtn" disabled>Disconnect Robot</button>
  </div>
  <pre id="connectLogs"></pre>
  <h2>Start Training</h2>
  <form id="trainForm">
    <label>Dataset Repo ID: <input name="dataset_repo_id" required></label><br>
    <label>Policy: <input name="policy" value="act"></label><br>
    <label>Extra Args (JSON array): <textarea name="extra_args">[]</textarea></label><br>
    <button type="submit">Start Training</button>
  </form>
  <pre id="trainResult"></pre>

  <h2>Start Inference</h2>
  <form id="inferenceForm">
    <label>Model Path: <input name="model_path" required></label><br>
    <label>Robot Type: <input name="robot_type" value="so100"></label><br>
    <label>Dataset Repo ID: <input name="repo_id"></label><br>
    <label>Single Task: <input name="single_task"></label><br>
    <label>Control Type: <input name="control_type" value="record"></label><br>
    <label>WebSocket URL: <input name="ws_url"></label><br>
    <label>Extra Args (JSON array): <textarea name="extra_args">[]</textarea></label><br>
    <button type="submit">Start Inference</button>
  </form>
  <pre id="inferenceResult"></pre>

  <h2>Stop Session</h2>
  <form id="stopForm">
    <label>Session ID: <input name="session_id" required></label><br>
    <button type="submit">Stop Session</button>
  </form>
  <pre id="stopResult"></pre>

  <h2>Check Session Status</h2>
  <form id="statusForm">
    <label>Session ID: <input name="session_id" required></label><br>
    <button type="submit">Check Status</button>
  </form>
  <pre id="statusResult"></pre>

  <h2>Session Logs</h2>
  <form id="logsForm">
    <label>Session ID: <input name="session_id" required></label>
    <button type="submit">Fetch Logs</button>
  </form>
  <pre id="logsResult"></pre>

  <script>
    let serialPort = null;
    let ws = null;
    let reader = null;

    function logConnect(msg) {
      const pre = document.getElementById('connectLogs');
      pre.textContent += msg + '\n';
      pre.scrollTop = pre.scrollHeight;
    }

    async function readSerialLoop() {
      while (serialPort && serialPort.readable) {
        reader = serialPort.readable.getReader();
        try {
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            if (ws && ws.readyState === WebSocket.OPEN) {
              ws.send(value);
            }
          }
        } catch (err) {
          logConnect('Read error: ' + err);
        } finally {
          reader.releaseLock();
        }
      }
    }

    async function connectRobot() {
      const wsUrl = document.getElementById('wsUrl').value || 'ws://localhost:8765';
      const baudRate = parseInt(document.getElementById('baudRate').value) || 115200;
      try {
        serialPort = await navigator.serial.requestPort();
        await serialPort.open({ baudRate });
        ws = new WebSocket(wsUrl);
        ws.binaryType = 'arraybuffer';
        ws.onopen = () => logConnect('WebSocket connected');
        ws.onclose = () => {
          logConnect('WebSocket closed');
          disconnectRobot();
        };
        ws.onmessage = (e) => {
          if (serialPort && serialPort.writable) {
            const writer = serialPort.writable.getWriter();
            writer.write(new Uint8Array(e.data));
            writer.releaseLock();
          }
        };
        readSerialLoop();
        document.getElementById('connectBtn').disabled = true;
        document.getElementById('disconnectBtn').disabled = false;
        logConnect('Serial port opened');
      } catch (err) {
        logConnect('Error: ' + err);
      }
    }

    function disconnectRobot() {
      if (reader) { reader.cancel(); reader.releaseLock(); }
      if (serialPort) {
        try { serialPort.close(); } catch (e) {}
        serialPort = null;
      }
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.close();
      }
      ws = null;
      document.getElementById('connectBtn').disabled = false;
      document.getElementById('disconnectBtn').disabled = true;
      logConnect('Disconnected');
    }

    document.getElementById('connectBtn').onclick = connectRobot;
    document.getElementById('disconnectBtn').onclick = disconnectRobot;

    document.getElementById('trainForm').onsubmit = async function(e) {
      e.preventDefault();
      const data = {
        dataset_repo_id: this.dataset_repo_id.value,
        policy: this.policy.value,
        extra_args: JSON.parse(this.extra_args.value)
      };
      const res = await fetch('/train', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      });
      document.getElementById('trainResult').textContent = await res.text();
    };

    document.getElementById('inferenceForm').onsubmit = async function(e) {
      e.preventDefault();
      const data = {
        model_path: this.model_path.value,
        robot_type: this.robot_type.value,
        repo_id: this.repo_id.value,
        single_task: this.single_task.value,
        control_type: this.control_type.value,
        ws_url: this.ws_url.value,
        extra_args: JSON.parse(this.extra_args.value)
      };
      const res = await fetch('/inference', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      });
      const result = await res.json();
      document.getElementById('inferenceResult').textContent = JSON.stringify(result, null, 2);
      if (result.session_id) {
        document.querySelector('#stopForm input[name="session_id"]').value = result.session_id;
        document.querySelector('#statusForm input[name="session_id"]').value = result.session_id;
        document.querySelector('#logsForm input[name="session_id"]').value = result.session_id;
      }
    };

    document.getElementById('stopForm').onsubmit = async function(e) {
      e.preventDefault();
      const sessionId = this.session_id.value;
      const res = await fetch('/session/' + sessionId, { method: 'DELETE' });
      document.getElementById('stopResult').textContent = await res.text();
    };

    document.getElementById('statusForm').onsubmit = async function(e) {
      e.preventDefault();
      const sessionId = this.session_id.value;
      const res = await fetch('/session/' + sessionId);
      document.getElementById('statusResult').textContent = await res.text();
    };

    document.getElementById('logsForm').onsubmit = async function(e) {
      e.preventDefault();
      const sessionId = this.session_id.value;
      const res = await fetch('/session/' + sessionId + '/logs');
      const data = await res.json();
      document.getElementById('logsResult').textContent = data.logs.join('\n');
    };
  </script>
</body>
</html>
